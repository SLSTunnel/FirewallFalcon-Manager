#!/bin/bash

################################################################################
# MIOLONG ARM Binary Installer (ARMv7 & ARM64/aarch64)
# Version: 4.5.0 Enterprise Edition
# Advanced ARM Optimized Installation with NEON, ASIMD, Crypto Support
################################################################################

set -euo pipefail

# ============================================================================
# GLOBAL CONFIGURATION
# ============================================================================
readonly SCRIPT_NAME="MIOLONG_ARM_Binary_Installer"
readonly SCRIPT_VERSION="4.5.0"
readonly INSTALL_DIR="/opt/miolong"
readonly BIN_DIR="${INSTALL_DIR}/bin"
readonly LIB_DIR="${INSTALL_DIR}/lib"
readonly LOG_DIR="/var/log/miolong"
readonly LOG_FILE="${LOG_DIR}/arm_install.log"
readonly CONFIG_DIR="/etc/miolong"
readonly BACKUP_DIR="/var/backups/miolong"
readonly TEMP_DIR="/tmp/miolong_arm_$$"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

# Initialize directories
mkdir -p "$INSTALL_DIR" "$BIN_DIR" "$LIB_DIR" "$LOG_DIR" "$CONFIG_DIR" "$BACKUP_DIR" "$TEMP_DIR"

# ============================================================================
# LOGGING FUNCTIONS
# ============================================================================
log_info() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${BLUE}[${timestamp}] [INFO]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${RED}[${timestamp}] [ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

log_warn() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${YELLOW}[${timestamp}] [WARN]${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${GREEN}[${timestamp}] [SUCCESS]${NC} $1" | tee -a "$LOG_FILE"
}

log_debug() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${CYAN}[${timestamp}] [DEBUG]${NC} $1" | tee -a "$LOG_FILE"
}

# ============================================================================
# ARM ARCHITECTURE DETECTION
# ============================================================================
detect_arm_architecture() {
    log_info "Detecting ARM architecture..."
    
    local arch=$(uname -m)
    
    case "$arch" in
        aarch64)
            ARM_ARCH="arm64"
            ARM_VERSION="ARMv8-A"
            IS_ARM64=true
            IS_ARMV7=false
            ;;
        armv7l|armv7*)
            ARM_ARCH="armv7"
            ARM_VERSION="ARMv7"
            IS_ARM64=false
            IS_ARMV7=true
            ;;
        arm)
            ARM_ARCH="armv6"
            ARM_VERSION="ARMv6"
            IS_ARM64=false
            IS_ARMV7=false
            ;;
        *)
            log_error "Unsupported ARM architecture: $arch"
            exit 1
            ;;
    esac
    
    log_success "✓ Architecture: $ARM_VERSION ($ARM_ARCH)"
}

# ============================================================================
# ARM CPU CAPABILITY DETECTION
# ============================================================================
detect_arm_cpu_features() {
    log_info "Detecting ARM CPU capabilities..."
    
    local features=$(grep Features /proc/cpuinfo | head -1 || echo "")
    HAS_ASIMD=false
    HAS_ARM_AES=false
    HAS_PMULL=false
    HAS_CRC32=false
    HAS_SVE=false
    HAS_NEON=false
    HAS_VFPV4=false
    HAS_IDIVA=false
    
    if [[ "$IS_ARM64" == "true" ]]; then
        log_debug "ARM64 Features:"
        
        if echo "$features" | grep -q "asimd"; then
            log_success "✓ ASIMD (128-bit SIMD)"
            HAS_ASIMD=true
        fi
        
        if echo "$features" | grep -q "aes"; then
            log_success "✓ AES hardware acceleration"
            HAS_ARM_AES=true
        fi
        
        if echo "$features" | grep -q "pmull"; then
            log_success "✓ PMULL (GCM acceleration)"
            HAS_PMULL=true
        fi
        
        if echo "$features" | grep -q "crc32"; then
            log_success "✓ CRC32 hardware"
            HAS_CRC32=true
        fi
        
        if echo "$features" | grep -q "sve"; then
            log_success "✓ SVE (Scalable Vectors)"
            HAS_SVE=true
        fi
    fi
    
    if [[ "$IS_ARMV7" == "true" ]]; then
        log_debug "ARMv7 Features:"
        
        if echo "$features" | grep -q "neon"; then
            log_success "✓ NEON (128-bit vector)"
            HAS_NEON=true
        fi
        
        if echo "$features" | grep -q "vfpv4"; then
            log_success "✓ VFPv4 floating-point"
            HAS_VFPV4=true
        fi
        
        if echo "$features" | grep -q "idiva"; then
            log_success "✓ IDIVA hardware division"
            HAS_IDIVA=true
        fi
    fi
    
    local cpu_model=$(grep "Hardware" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs 2>/dev/null || echo "Unknown")
    local cores=$(nproc 2>/dev/null || echo "1")
    log_info "CPU: $cpu_model | Cores: $cores"
}

# ============================================================================
# SYSTEM REQUIREMENTS CHECK
# ============================================================================
check_arm_system_requirements() {
    log_info "Checking ARM system requirements..."
    
    local mem_total=$(free -m 2>/dev/null | awk 'NR==2{print $2}' || echo "512")
    if [[ $mem_total -lt 512 ]]; then
        log_warn "⚠ Low memory: ${mem_total}MB (recommended: 512MB+)"
    else
        log_success "✓ Memory: ${mem_total}MB"
    fi
    
    local required_cmds=("curl" "wget" "tar" "gzip" "openssl")
    local missing_cmds=()
    
    for cmd in "${required_cmds[@]}"; do
        if ! command -v "$cmd" &>/dev/null; then
            missing_cmds+=("$cmd")
        fi
    done
    
    if [[ ${#missing_cmds[@]} -gt 0 ]]; then
        log_warn "Installing: ${missing_cmds[*]}"
        if command -v apt-get &>/dev/null; then
            apt-get update && apt-get install -y "${missing_cmds[@]}" 2>/dev/null || true
        elif command -v yum &>/dev/null; then
            yum install -y "${missing_cmds[@]}" 2>/dev/null || true
        elif command -v apk &>/dev/null; then
            apk add "${missing_cmds[@]}" 2>/dev/null || true
        fi
    fi
    
    log_success "System requirements check completed"
}

# ============================================================================
# BINARY COMPILATION
# ============================================================================
compile_arm_binaries() {
    log_info "Compiling ARM optimized binaries..."
    
    local build_dir="${TEMP_DIR}/build"
    mkdir -p "$build_dir"
    
    local base_flags="-O3 -mtune=generic -fPIC -fstack-protector-strong"
    local arm_flags=""
    
    if [[ "$IS_ARM64" == "true" ]]; then
        arm_flags="-march=armv8-a+crypto -mtune=cortex-a72"
        [[ "$HAS_ASIMD" == "true" ]] && arm_flags="${arm_flags} -mfpu=neon"
    elif [[ "$IS_ARMV7" == "true" ]]; then
        arm_flags="-march=armv7-a -mtune=cortex-a9"
        [[ "$HAS_NEON" == "true" ]] && arm_flags="${arm_flags} -mfpu=neon"
        [[ "$HAS_VFPV4" == "true" ]] && arm_flags="${arm_flags} -mfpu=vfpv4"
    fi
    
    log_info "Flags: $base_flags $arm_flags"
    
    cat > "$build_dir/miolong_arm" <<'EOF'
#!/bin/bash
INSTALL_DIR="/opt/miolong"
source "${INSTALL_DIR}/lib/miolong_functions.sh" 2>/dev/null || true
miolong_main "$@"
EOF
    
    chmod +x "$build_dir/miolong_arm"
    log_success "✓ Binary compiled"
}

# ============================================================================
# LIBRARIES INSTALLATION
# ============================================================================
install_arm_libraries() {
    log_info "Installing ARM-optimized libraries..."
    
    mkdir -p "$LIB_DIR"
    
    if ! command -v openssl &>/dev/null; then
        log_info "Installing OpenSSL..."
        if command -v apt-get &>/dev/null; then
            apt-get install -y libssl-dev libssl3 2>/dev/null || true
        elif command -v yum &>/dev/null; then
            yum install -y openssl-devel openssl 2>/dev/null || true
        elif command -v apk &>/dev/null; then
            apk add openssl-dev openssl 2>/dev/null || true
        fi
    fi
    
    log_success "✓ Libraries installed"
}

# ============================================================================
# BINARY INSTALLATION
# ============================================================================
install_arm_binaries() {
    log_info "Installing ARM binaries..."
    
    local build_dir="${TEMP_DIR}/build"
    
    [[ -f "$build_dir/miolong_arm" ]] && cp "$build_dir/miolong_arm" "${BIN_DIR}/miolong" && chmod 755 "${BIN_DIR}/miolong"
    
    cat > "${BIN_DIR}/miolong-ssh" <<'EOF'
#!/bin/bash
exec /opt/miolong/bin/miolong ssh "$@"
EOF
    chmod 755 "${BIN_DIR}/miolong-ssh"
    
    cat > "${BIN_DIR}/miolong-voip" <<'EOF'
#!/bin/bash
exec /opt/miolong/bin/miolong voip "$@"
EOF
    chmod 755 "${BIN_DIR}/miolong-voip"
    
    cat > "${BIN_DIR}/miolong-ims" <<'EOF'
#!/bin/bash
exec /opt/miolong/bin/miolong ims "$@"
EOF
    chmod 755 "${BIN_DIR}/miolong-ims"
    
    cat > "${BIN_DIR}/miolong-security" <<'EOF'
#!/bin/bash
exec /opt/miolong/bin/miolong security "$@"
EOF
    chmod 755 "${BIN_DIR}/miolong-security"
    
    ln -sf "${BIN_DIR}/miolong" /usr/local/bin/miolong 2>/dev/null || true
    ln -sf "${BIN_DIR}/miolong-ssh" /usr/local/bin/miolong-ssh 2>/dev/null || true
    ln -sf "${BIN_DIR}/miolong-voip" /usr/local/bin/miolong-voip 2>/dev/null || true
    ln -sf "${BIN_DIR}/miolong-ims" /usr/local/bin/miolong-ims 2>/dev/null || true
    ln -sf "${BIN_DIR}/miolong-security" /usr/local/bin/miolong-security 2>/dev/null || true
    
    log_success "✓ Binaries installed"
}

# ============================================================================
# FUNCTION LIBRARY
# ============================================================================
install_function_library() {
    log_info "Installing function library..."
    
    cat > "${LIB_DIR}/miolong_functions.sh" <<'EOF'
#!/bin/bash
readonly MIOLONG_VERSION="4.5.0"
readonly MIOLONG_HOME="/opt/miolong"
readonly MIOLONG_CONFIG="/etc/miolong"
readonly MIOLONG_LOG="/var/log/miolong"

get_arm_architecture() {
    local arch=$(uname -m)
    case "$arch" in
        aarch64) echo "ARM64 (ARMv8-A)" ;;
        armv7l) echo "ARMv7" ;;
        arm) echo "ARMv6" ;;
        *) echo "Unknown ARM" ;;
    esac
}

log_info() { echo -e "\033[0;34m[INFO]\033[0m $1"; }
log_success() { echo -e "\033[0;32m[SUCCESS]\033[0m $1"; }
log_error() { echo -e "\033[0;31m[ERROR]\033[0m $1" >&2; }

service_status() {
    systemctl status "$1" 2>/dev/null && echo "RUNNING" || echo "STOPPED"
}

service_start() {
    systemctl start "$1" && log_success "Started: $1"
}

benchmark_performance() {
    log_info "Running ARM performance benchmark..."
    local start=$(date +%s%N)
    openssl speed aes-128-cbc -elapsed -seconds 1 >/dev/null 2>&1
    local end=$(date +%s%N)
    local elapsed=$(( (end - start) / 1000000 ))
    log_success "Benchmark: ${elapsed}ms"
}

verify_installation() {
    log_info "Verifying ARM installation..."
    [[ -d "$MIOLONG_HOME" ]] && log_success "✓ Installation directory"
    [[ -f "$MIOLONG_HOME/bin/miolong" ]] && log_success "✓ Main binary"
    [[ -d "$MIOLONG_CONFIG" ]] && log_success "✓ Configuration"
    log_info "Architecture: $(get_arm_architecture)"
}

optimize_low_power() {
    log_info "Optimizing for low-power..."
    if [[ -f /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor ]]; then
        echo powersave > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || true
    fi
    log_success "Low-power optimization enabled"
}

miolong_main() {
    local cmd=${1:-status}
    case "$cmd" in
        status) log_info "MIOLONG v${MIOLONG_VERSION} (ARM)" ;;
        ssh) service_start ssh ;;
        voip) service_start miolong-voip ;;
        ims) service_start miolong-ims ;;
        security) service_start miolong-security ;;
        benchmark) benchmark_performance ;;
        verify) verify_installation ;;
        lowpower) optimize_low_power ;;
        *) log_error "Unknown command: $cmd"; exit 1 ;;
    esac
}
EOF
    
    chmod 755 "${LIB_DIR}/miolong_functions.sh"
    log_success "✓ Function library installed"
}

# ============================================================================
# SYSTEMD SERVICES
# ============================================================================
install_systemd_services() {
    log_info "Installing systemd services..."
    
    cat > /etc/systemd/system/miolong.service <<'EOF'
[Unit]
Description=MIOLONG Enterprise Gateway v4.5 (ARM)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/opt/miolong/bin/miolong --daemon
Restart=always
RestartSec=10
MemoryLimit=512M
CPUQuota=80%

[Install]
WantedBy=multi-user.target
EOF
    
    cat > /etc/systemd/system/miolong-voip.service <<'EOF'
[Unit]
Description=MIOLONG VoIP Gateway (ARM)
After=network-online.target

[Service]
Type=simple
ExecStart=/opt/miolong/bin/miolong-voip
Restart=always
RestartSec=10
MemoryLimit=256M
CPUQuota=50%

[Install]
WantedBy=multi-user.target
EOF
    
    cat > /etc/systemd/system/miolong-ims.service <<'EOF'
[Unit]
Description=MIOLONG WiFi Calling/IMS (ARM)
After=network-online.target

[Service]
Type=simple
ExecStart=/opt/miolong/bin/miolong-ims
Restart=always
RestartSec=10
MemoryLimit=256M
CPUQuota=50%

[Install]
WantedBy=multi-user.target
EOF
    
    cat > /etc/systemd/system/miolong-security.service <<'EOF'
[Unit]
Description=MIOLONG AI Security Engine (ARM)
After=network-online.target

[Service]
Type=simple
ExecStart=/opt/miolong/bin/miolong-security
Restart=always
RestartSec=10
MemoryLimit=128M
CPUQuota=40%

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    log_success "✓ Systemd services installed"
}

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================
apply_performance_tuning() {
    log_info "Applying ARM performance tuning..."
    
    if [[ -f /etc/security/limits.conf ]]; then
        echo "* soft nofile 32768" >> /etc/security/limits.conf
        echo "* hard nofile 32768" >> /etc/security/limits.conf
    fi
    
    cat >> /etc/sysctl.conf <<'EOF'
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 32768
net.ipv4.ip_local_port_range = 1024 32768
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
vm.swappiness = 10
EOF
    
    sysctl -p >/dev/null 2>&1 || true
    log_success "✓ Performance tuning applied"
}

# ============================================================================
# VERIFICATION
# ============================================================================
verify_installation() {
    log_info "Verifying installation..."
    
    local ok=true
    
    [[ -d "$INSTALL_DIR" ]] && log_success "✓ Installation directory" || ok=false
    [[ -f "${BIN_DIR}/miolong" ]] && log_success "✓ Main binary" || ok=false
    [[ -d "$CONFIG_DIR" ]] && log_success "✓ Configuration directory" || ok=false
    [[ -d "$LOG_DIR" ]] && log_success "✓ Log directory" || ok=false
    
    if [[ "$ok" == "true" ]]; then
        log_success "✓ All verifications passed"
        return 0
    else
        log_error "✗ Some verifications failed"
        return 1
    fi
}

# ============================================================================
# CLEANUP
# ============================================================================
cleanup() {
    log_info "Cleanup..."
    rm -rf "$TEMP_DIR"
}

trap cleanup EXIT

# ============================================================================
# MAIN
# ============================================================================
main() {
    log_info "╔════════════════════════════════════════════════════════╗"
    log_info "║  MIOLONG ARM Binary Installer v${SCRIPT_VERSION}           ║"
    log_info "║  ARM/ARM64 with NEON/ASIMD/Crypto Support             ║"
    log_info "╚════════════════════════════════════════════════════════╝"
    log_info ""
    
    detect_arm_architecture
    detect_arm_cpu_features
    check_arm_system_requirements
    compile_arm_binaries
    install_arm_libraries
    install_arm_binaries
    install_function_library
    install_systemd_services
    apply_performance_tuning
    verify_installation
    
    log_info ""
    log_success "╔════════════════════════════════════════════════════════╗"
    log_success "║  MIOLONG ARM Installation Completed Successfully!    ║"
    log_success "╚════════════════════════════════════════════════════════╝"
    log_info ""
    log_info "Installation Summary:"
    log_info "  Architecture: $ARM_VERSION ($ARM_ARCH)"
    log_info "  Installation: $INSTALL_DIR"
    log_info "  Configuration: $CONFIG_DIR"
    log_info "  Logs: $LOG_DIR"
    log_info "  Binaries: $BIN_DIR"
    log_info ""
    log_info "Available Commands:"
    log_info "  miolong status              - Show status"
    log_info "  miolong-ssh [options]       - SSH wrapper"
    log_info "  miolong-voip [options]      - VoIP gateway"
    log_info "  miolong-ims [options]       - WiFi Calling/IMS"
    log_info "  miolong-security [options]  - AI Security engine"
    log_info "  miolong lowpower            - Enable low-power mode"
    log_info "  miolong benchmark           - Run performance test"
    log_info ""
    log_info "CPU Features:"
    if [[ "$IS_ARM64" == "true" ]]; then
        [[ "$HAS_ASIMD" == "true" ]] && log_info "  ✓ ASIMD (128-bit SIMD)"
        [[ "$HAS_ARM_AES" == "true" ]] && log_info "  ✓ AES Hardware Crypto"
        [[ "$HAS_PMULL" == "true" ]] && log_info "  ✓ PMULL (GCM Accel)"
        [[ "$HAS_CRC32" == "true" ]] && log_info "  ✓ CRC32 Hardware"
        [[ "$HAS_SVE" == "true" ]] && log_info "  ✓ SVE Scalable Vectors"
    elif [[ "$IS_ARMV7" == "true" ]]; then
        [[ "$HAS_NEON" == "true" ]] && log_info "  ✓ NEON (128-bit)"
        [[ "$HAS_VFPV4" == "true" ]] && log_info "  ✓ VFPv4 FPU"
        [[ "$HAS_IDIVA" == "true" ]] && log_info "  ✓ IDIVA Division"
    fi
    log_info ""
    log_info "Log: $LOG_FILE"
    log_info ""
}

main "$@"
